---
- name: Copy prereq list
  copy: src={{ pca_prereq }}
        dest={{ pca_tempdir}}/pca_patches/{{ pca_prereq }}

- name: Install prerequisite patches in live BE
  shell: "{{ pca_tempdir }}/pca -i {{ pca_tempdir}}/pca_patches/{{ pca_prereq }} -y -X {{ pca_tempdir }}/pca_patches -P {{ pca_tempdir }}/pca_patches"

- name: Fix for Sun CR 6804076
  lineinfile: dest=/etc/zones/index
              regexp='^global{{":"}}configured.*'
              backrefs=yes
              line='global{{":"}}installed{{":"}}/'

- name: get current date for reference as ABE name
  command: /usr/bin/date +%Y%m%d
  register: pca_abe
  changed_when: false

- name: Create ABE
  shell: /usr/sbin/lucreate -n {{ pca_abe.stdout }}

- name: Set solaris upgrade variable if desired
  set_fact: pca_solaris_upgrade_10u11=true
  when:
  - "'1/13' not in ansible_distribution_release"
  - pca_try_release_upgrade

- include: upgrade.yml
  when:
  - pca_try_release_upgrade
  - pca_solaris_upgrade_10u11 is defined
  - pca_solaris_upgrade_10u11

- name: Mount ABE
  shell: /usr/sbin/lumount {{ pca_abe.stdout }}
  register: pca_abe_mountpoint

- name: Install patches to ABE
  shell: "( ( nohup {{ pca_tempdir }}/pca -i {{ solaris_pca_operand }} -y -X {{ pca_tempdir }}/pca_patches -P {{ pca_tempdir }}/pca_patches {% if pca_ignorelist %} --ignore={{ pca_ignorelist }}{% endif %} -R {{ pca_abe_mountpoint.stdout }} > {{ pca_tempdir }}/pca_patches/pca.log 2>&1& ) & )"
  args:
    executable: /usr/bin/bash
    chdir: "{{ pca_tempdir }}/pca_patches"
    creates: pca.log

- name: Wait for patch installation to complete
  wait_for: path={{ pca_tempdir }}/pca_patches/pca.log
            search_regex='^Install Summary.*total.*successful.*skipped.*failed$'
            state=present
            connect_timeout=60

- name: Get Installation log
  fetch: src={{ pca_tempdir }}/pca_patches/pca.log
         dest={{ pca_basedir }}}/{{ inventory_hostname }}/{{ inventory_hostname }}_pca.log
         flat=yes
         fail_on_missing=yes

- name: Email installation report
  shell: ( echo 'To{{":"}} {{ pca_destination_address }}'; echo 'From{{":"}} {{ pca_source_address }}'; echo 'Content-Type{{":"}} text/html'; echo 'MIME-Version{{":"}} 1.0'; echo 'Subject{{":"}} Solaris Patch Installation report - {{ inventory_hostname }}'; echo; cat {{ pca_basedir }}/{{ inventory_hostname }}/{{ inventory_hostname }}_pca.log ) | /usr/sbin/sendmail -t
  args:
    executable: /bin/bash
  delegate_to: localhost
  when:
  - pca_send_email

- name: Update ABE Ramdisk
  shell: "{{ pca_abe_mountpoint }}/boot/solaris/bin/create_ramdisk -R {{ pca_abe_mountpoint.stdout }}"

- name: Cleanup ABE pushed patch repo
  file: path={{ pca_abe_mountpoint.stdout }}{{ pca_tempdir }}/{{ item }}
        state=absent
  with_items:
  - pca_patches
  - pca
  - showrev.out
  - pkginfo.out
  - uname.out

- name: Cleanup pushed patch repo
  file: path={{ pca_tempdir }}/{{ item }}
        state=absent
  with_items:
  - pca_patches
  - pca
  - showrev.out
  - pkginfo.out
  - uname.out
  - patchdiag.xref

- name: Remove pca local fact from ABE
  file: state=absent
        path={{ pca_abe_mountpoint.stdout }}/etc/ansible/facts.d/pca.fact

- name: Umount ABE
  shell: /usr/sbin/luumount {{ pca_abe.stdout }}

- name: Create dir for custom facts
  file: state=directory
        recurse=yes
        path=/etc/ansible/facts.d

- name: Populate custom fact with ABE ready for activation
  template: src=pca.fact.j2
            dest=/etc/ansible/facts.d/pca.fact
